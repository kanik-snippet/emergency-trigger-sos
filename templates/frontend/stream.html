{% extends 'frontend/nav.html' %}
{% load static %}
{% load i18n %}

{% block title %}Live Stream Dashboard{% endblock %}

{% block head %}
    <title>Live Stream</title>
    
    <style>
        .stream-wrapper {
            margin-bottom: 30px;
        }
    </style>
{% endblock %}

{% block body %}
<h2 id="status">Checking live streams...</h2>
<div id="video-container"></div>  <!-- Holds all streams -->
<link href="https://vjs.zencdn.net/7.21.1/video-js.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://vjs.zencdn.net/7.21.1/video.min.js"></script>

<script>
async function checkStream() {
    const token = localStorage.getItem("access_token");

    try {
        const response = await fetch('/api/check-stream/', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();
        console.log("API Response:", data);

        const container = document.getElementById("video-container");
        const status = document.getElementById("status");
        container.innerHTML = ""; // Clear old videos

        if (data.live && data.allowed && data.streams && data.streams.length > 0) {
            status.innerText = `üî¥ ${data.streams.length} Live Stream(s) ON`;

            data.streams.forEach((stream, index) => {
                const streamKey = stream.stream_key;
                const hlsUrl = stream.url;
                const videoId = `video-${index}`;

                // Video wrapper
                const wrapper = document.createElement("div");
                wrapper.className = "stream-wrapper";

                // Create video element
                const videoHTML = `
                    <video id="${videoId}" class="video-js vjs-default-skin" controls autoplay style="width: 640px; height: 360px;">
                        <source src="${hlsUrl}" type="application/x-mpegURL">
                    </video>
                `;
                wrapper.innerHTML = videoHTML;
                container.appendChild(wrapper);

                // Initialize HLS.js for better compatibility
                const video = document.getElementById(videoId);
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(hlsUrl);
                    hls.attachMedia(video);
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = hlsUrl;
                }

                // Optional: Init video.js styling
                videojs(video);
            });

        } else if (!data.allowed) {
            status.innerText = "‚ùå You are not authorized to view streams.";
        } else {
            status.innerText = "üîò No live streams found.";
        }

    } catch (err) {
        document.getElementById("status").innerText = "‚ùå Error checking stream.";
        console.error(err);
    }
}

checkStream();  // Initial load
setInterval(checkStream, 10000);  // Refresh every 10s
</script>
{% endblock %}
